<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>signup</title>

</head>
<body>
  <style>
    #toz {
      display: none;
    }
  </style>
  <script>

  var C_USER_ID = "user_id";
  var C_USER_NAME = "user_name";

  /**
  * Créer un cookie
  *
  * @param cname
  *            le nom du cookie
  * @param cvalue
  *            la valeur du cookie
  */
  function setCookie(cname, cvalue) {
    document.cookie = cname + "=" + cvalue;
  }
  /**
  * Récupère la valeur d'un cookie
  *
  * @param cname
  *            le nom du cookie dont on souhaite la valeur
  *
  */
  function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');

    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];

      while (c.charAt(0) == ' ')
      c = c.substring(1);

      if (c.indexOf(name) == 0) {
        str = c.substring(name.length, c.length);
        if (str == "-1") {
          return null;
        }
        return str;
      }
    }

    return null;
  }

  /**
  * Permet de détruire un cookie en mettant sa valeur à -1
  */
  function destroy_cookie() {
    setCookie(C_USER_ID, "-1");
    setCookie(C_USER_NAME, "-1");
  }

  function signup() {
    var form = document.getElementById('myform');
    var login = form.username.value;
    var pwd = form.password.value;
    var prenom = form.prenom.value;
    var nom = form.nom.value;
    var age = form.age.value;
    var req = new XMLHttpRequest();
    req.open("POST", 'http://localhost/Memos/signup', true);
    req.onreadystatechange = function(evt) {
      if (req.readyState == 4) {
        if(req.status == 200) {
          console.log("debug - signupResponse : "+req.responseText);
          var json = JSON.parse(req.responseText);
          if (json.error == undefined) {
            document.getElementById('response').innerHTML = json.success;
          }
          else {
            document.getElementById('response').innerHTML = json.error;
          }
        }
        else
        console.error("error");
      }
    }
    var data = {};
    data.login = login;
    data.password = pwd;
    data.prenom = prenom;
    data.nom = nom;
    data.age = age;
    form.nom.value = "";
    form.prenom.value = "";
    form.age.value = "";
    console.log("signing up with "+JSON.stringify(data));
    req.send (JSON.stringify(data));
  }

  function login() {
    var form = document.getElementById('myform');
    var login = form.username.value;
    var pwd = form.password.value;
    var req = new XMLHttpRequest();
    req.open("POST", 'http://localhost/Memos/login');
    req.onreadystatechange = function(evt) {
      if (req.readyState == 4) {
        if(req.status == 200) {
          console.log("debug - loginResponse : "+req.responseText);
          var json = JSON.parse(req.responseText);
          if (json.error == undefined) {
            setCookie(C_USER_ID, json.id)
            setCookie(C_USER_NAME, login)
            getMemos();
            getUserInfo();
            document.getElementById('toz').style.display = "inline";
          } else {
            document.getElementById('response').innerHTML = json.error;
          }
        }
        else {
          console.error("error");
        }
      }
    }
    var data = {};
    data.login = login;
    data.password = pwd;
    console.log("signing up with "+JSON.stringify(data));
    req.send (JSON.stringify(data));

  }

  function logout() {
    var req = new XMLHttpRequest();
    req.open("POST", 'http://localhost/Memos/logout');
    req.onreadystatechange = function(evt) {
      if (req.readyState == 4) {
        if(req.status == 200) {
          console.log("debug - logoutResponse : "+req.responseText);
          var json = JSON.parse(req.responseText);
          if (json.error == undefined) {
            destroy_cookie();
            document.getElementById('user').innerHTML = "";
            document.getElementById('notes').innerHTML = "";
            document.getElementById('toz').style.display = "none";
            docue
          } else {
            document.getElementById('response').innerHTML = json.error;
          }
        }
        else {
          console.error("error");
        }
      }
    }
    req.send();
  }

  function addMemo() {
    var form = document.getElementById('memoform');
    var memo = form.memo.value;
    var req = new XMLHttpRequest();
    req.open("POST", 'http://localhost/Memos/addMemo');
    req.onreadystatechange = function(evt) {
      if (req.readyState == 4) {
        if(req.status == 200) {
          console.log("debug - addMemoResponse : "+req.responseText);
          var json = JSON.parse(req.responseText);
          if (json.error == undefined) {
            document.getElementById('response').innerHTML = json.success;
            getMemos();
          } else {
            document.getElementById('response').innerHTML = json.error;
          }
        }
        else {
          console.error("error");
        }
      }
    }
    var data = {};
    data.userId = getCookie(C_USER_ID);
    data.memo = memo;
    if (data.userId != null && data.memo != "") {
      form.memo.value = "";
      console.log("adding up with "+JSON.stringify(data));
      req.send (JSON.stringify(data));
    }
  }

  function removeMemo(memoId) {
    var req = new XMLHttpRequest();
    req.open("POST", 'http://localhost/Memos/removeMemo');
    req.onreadystatechange = function(evt) {
      if (req.readyState == 4) {
        if(req.status == 200) {
          console.log("debug - removeMemoResponse : "+req.responseText);
          var json = JSON.parse(req.responseText);
          if (json.error == undefined) {
            document.getElementById('response').innerHTML = json.success;
            getMemos();
          } else {
            document.getElementById('response').innerHTML = json.error;
          }
        }
        else {
          console.error("error");
        }
      }
    }
    var data = {};
    data.userId = getCookie(C_USER_ID);
    data.memoId = memoId;
    console.log("adding up with "+JSON.stringify(data));
    req.send (JSON.stringify(data));
  }

  function getMemos() {
    var req = new XMLHttpRequest();
    var id = getCookie(C_USER_ID);
    console.log("id = "+id);
    if (id != null) {
      req.open("GET", 'http://localhost/Memos/getMemos?userId='+id);
      req.onreadystatechange = function(evt) {
        if (req.readyState == 4) {
          if(req.status == 200) {
            console.log("debug - getMemosResponse : "+req.responseText);
            var json = JSON.parse(req.responseText);
            if (json.error == undefined) {
              afficherMemo(json);
            } else {
              document.getElementById('response').innerHTML = json.error;
            }
          }
          else {
            console.error("error");
          }
        }
      }
      req.send ();
    }
  }

  function afficherMemo(json) {
    var tab = json.memos;
    var length = tab.length;

    var notes = document.getElementById('notes');
    notes.innerHTML = "";
    for (var i = 0; i<length; i++) {
      var div = document.createElement("div");
      div.innerHTML = "<span>"+tab[i]+"<span><button onclick=removeMemo("+i+")>remove</button>";
      notes.appendChild(div);
    }
  }

  function getUserInfo() {
    var req = new XMLHttpRequest();
    var id = getCookie(C_USER_NAME);
    if (id != null) {

      req.open("GET", 'http://localhost/Memos/user?username='+id);
      req.onreadystatechange = function(evt) {
        if (req.readyState == 4) {
          if(req.status == 200) {
            console.log("debug - getMemosResponse : "+req.responseText);
            document.getElementById('user').innerHTML = req.responseText;
          }
          else {
            console.error("error");
          }
        }
      }
      req.send();
    }
  }

  </script>
  <div id="main">

    <div>
      <form id="myform" >
        <input type="text" name="username" placeholder="login"/>
        <input type="password" name="password" placeholder="password"/>
        <input type="text" name="prenom" placeholder="prenom"/>
        <input type="text" name="nom" placeholder="nom"/>
        <input type="number" name="age" placeholder="age"/>
      </form>
      <button id="signup" onclick="signup()">Signup</button>
      <button id="login" onclick="login()">Login</button>
      <button id="logout" onclick="logout()">Logout</button>
    </div>
    <br>
    <div id=toz>
      <form id="memoform">
        <input type="text" name="memo" placeholder="Tapez votre memo">
      </form>
      <button id="signup" onclick="addMemo()">Ajouter</button>
    </div>
    <br>
    <div id=response>

    </div>
    <br>
    <div id=notes>

    </div>
    <br>
    <div id=user>

    </div>

  </div>
  <script>
  getMemos();
  getUserInfo();
  </script>
</body>
</html>
